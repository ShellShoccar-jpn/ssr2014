\section{全角・半角文字の相互変換}
\label{recipe:han_zen}

\subsection*{問題}
\noindent
$\!\!\!\!\!$
\begin{grshfboxit}{160.0mm}
	大文字・小文字を区別せず、更に全角・半角も区別せずにテキスト検索がやりたい。
	全角文字を半角に変換することさえできればあとは簡単なのだが。
\end{grshfboxit}

\subsection*{回答}
下記のような正直な処理を行うプログラムを書けばよい。
\begin{itemize}
  \item テキストデータを1バイトずつ読み、各文字が何バイト使っているのかを認識しながら読み進めていく。
  \item その際、半角文字に変換可能な文字に遭遇した場合は置換する。
\end{itemize}

\subsubsection*{全角文字→半角文字変換コマンド``han''}

とは言っても毎回それを書くのも大変だ。しかし例によってPOSIXの範囲で実装し、コマンド化したものがGitHubに公開されている。``han''という名のコマンドだ。これはシェルスクリプト開発者向けコマンドセットOpen usp Tukubainにある同名コマンドを、POSIX原理主義に基づいたシェルスクリプトで書き直した互換コマンドである。これをダウンロード\footnote{\verb|https://github.com/ShellShoccar-jpn/Open-usp-Tukubai/blob/master/COMMANDS.SH/han|にアクセスし、そこにあるソースコードをコピー\&{}ペーストしてもよいし、あるいは``RAW''と書かれているリンク先を「名前を付けて保存」してもよい。}して用いる。

例えば、次のようなテキストファイル（enquete.txt）があったとする。\\
\begin{frameboxit}{160.0mm}
\begin{verbatim}
	#name                 ans1  ans2
	Ｍｏｇａｍｉ           yes   no
	Kaga                  no    yes
	fubuki                yes   yes
	ｍｕｔｓｕ             no    no
	Ｓｈｉｍａｋａｚｅ      no    yes
\end{verbatim}
\end{frameboxit}

アンケート回答がまとまっているのだが、回答者によって自分の名前を全角で打ち込んだり半角で打ち込んだり、まちまちというわけだ。回答者名で検索したいとなった時、検索する側はいちいち大文字・小文字や全角・半角を区別したくない。このよう時に、hanコマンドを使うのである。

次のようにしてhanコマンドに掛けた後、trコマンドで大文字を全て小文字に変換する（その後でAWKに掛けているのは見やすさのためだ）。
\begin{screen}
	\verb!$ ./han enquete.txt | tr A-Z a-z | awk '{printf("%-10s %-4s %-4s\n",$1,$2,$3);}'!\return \\
	\verb|#name      ans1 ans2| \\
	\verb|mogami     yes  no  | \\
	\verb|kaga       no   yes | \\
	\verb|fubuki     yes  yes | \\
	\verb|mutsu      no   no  | \\
	\verb|shimakaze  no   yes | \\
	\verb|$ |
\end{screen}

こうしておけば、半角英数字で簡単に回答者名のgrep検索が可能だ。

尚、この\textbf{hanコマンドはUTF-8のテキストにしか対応しておらず}、JISやShitf JIS、EUC-JPテキストには対応していない。そのような文字を扱いたい場合は、iconvコマンドを用いたり、nkfコマンド（こちらはPOSIXではないが）を用いて予めUTF-8に変換しておくこと。

\subsubsection*{半角文字→全角文字変換コマンド``zen''}

今回の問題では必要なかったが、hanコマンドとは逆に、文字を全角に変換するコマンドもある。``zen''という名のコマンドだ。これもOpen usp Tukubaiに存在する同名コマンドをPOSIX原理主義シェルスクリプトで書き直した互換コマンドが存在する。必要に応じてダウンロード\footnote{\verb|https://github.com/ShellShoccar-jpn/Open-usp-Tukubai/blob/master/COMMANDS.SH/zen|にアクセスし、そこにあるソースコードをコピー\&{}ペーストしてもよいし、あるいは``RAW''と書かれているリンク先を「名前を付けて保存」してもよい。}して用いてもらいたい。

通常は全ての文字を全角文字に変換するのだが、\verb|-k|オプションを付けると半角カタカナのみ全角変換することができる。
\begin{screen}
	\verb!$ echo '!$\!\!\!${\footnotesize ハ}$\!\!\!\!${\footnotesize ン}$\!\!\!\!${\footnotesize カ}$\!\!\!\!${\footnotesize ク}\verb!文字はe-mailでは使えません。' | ./zen -k!\return \\
	\verb|ハンカク文字はe-mailでは使えません。| \\
	\verb|$ |
\end{screen}

これはe-mail送信用のテキストファイルを作る際に有用だ。

尚、zenコマンドもやはりUTF-8専用である。

\subsection*{解説}

全角混じりのテキストだって取り扱いを諦めることはない。一文字一文字愚直に、変換可能なものを変換していけばいいだけだ。ただ、その際に問題になるのはマルチバイトの扱いである。1バイトずつ読んだ場合、それがマルチバイト文字の終端なのか、それとも途中なのかということを常に判断しなければならない。

han、zenコマンドは文字エンコードがUTF-8前提で作られているが、そのためにはUTF-8の各文字のバイト長を正しく認識しなければならない。その情報は、Wikipedia日本語版のUTF-8のページにも記載されている。1文字読み込んでみてそのキャラクターコードがどの範囲にあるかということを判定していくと、1バイトから6バイトの範囲で長さを決定することができる。han、zenにはそのようなルーチンが実装されている。

そして1文字分読み取った結果、それと対になる半角文字あるいは全角文字が存在する時は、元の文字ではなく用意していた対の文字を出力すればよい。この時もPOSIX版AWKがやっていることはとても単純だ。対になる文字を全てAWKの連想配列に登録しておき、要素が存在すれば代わりに出力しているに過ぎない。ただし、半角カタカナから全角カタカナへの変換の時には注意事項がある。それは濁点、半濁点の処理だ。例えば、半角の「ハ」の直後に半角の「゜」が連なっていたら「ハ゜」ではなくて「パ」に変換しなければならないので、「ハ」が来た時点ですぐに置換処理をしてはならずに次の文字を見てからにしなければならないのだ。

このようにやり方を聞いて「なんてベタな書き方だ」と笑うかもしれない。しかし\textbf{速度の問題が生じない限り、プログラムはベタに書く方がいい。}その方が、他人にとっても、そして将来の自分にとっても、メンテナンスしやすいプログラムになる。UNIX哲学の定理その1
\begin{quote}
	Small is beautiful.
\end{quote}
のとおりだ。

\subsection*{参照}

\noindent
→\ref{recipe:hira_kata}（ひらがな・カタカナの相互変換）
